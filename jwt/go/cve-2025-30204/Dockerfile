FROM golang:1.25-alpine AS builder

RUN apk add --no-cache gcc musl-dev sqlite-dev

WORKDIR /app
COPY go.mod go.sum main.go ./

ARG JWT_VERSION=""
RUN if [ -n "$JWT_VERSION" ]; then \
      v="$JWT_VERSION"; \
      case "$v" in v*) ;; *) v="v$v" ;; esac; \
      go mod edit -require=github.com/golang-jwt/jwt/v4@$v; \
    fi && \
    go mod tidy

ENV CGO_ENABLED=1

RUN go build -mod=readonly -trimpath -ldflags="-s -w" -o /out/jwtgo main.go

FROM alpine:3.20
RUN apk add --no-cache sqlite-libs

RUN addgroup -S -g 10001 app \
 && adduser  -S -D -H -u 10001 -G app app
USER app

WORKDIR /app
COPY --from=builder /out/jwtgo /app/jwtgo

EXPOSE 8080 6060

ENTRYPOINT ["/app/jwtgo"]